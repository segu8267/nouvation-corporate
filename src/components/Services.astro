---
// Services Component
import { getMarketPrices } from "../lib/market";
const marketPrices = await getMarketPrices();
---

<!-- Section Title -->
<section data-section-theme="light" id="services" class="pt-24 md:pt-32 pb-12 md:pb-16 bg-[#F6F6EE]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="text-center fade-up">
      <h2 class="text-3xl md:text-5xl font-bold mb-2 leading-relaxed text-[#231815]">
        <span class="font-maru">SERVICE</span>
      </h2>
      <p class="text-lg md:text-xl text-[#231815] mb-4">
        NOUVATIONが提供する4つのサービス
      </p>
    </div>
  </div>
</section>

<!-- Service 01: Market Graph -->
<section data-section-theme="light" id="service-01" class="pt-12 md:pt-16 pb-24 md:pb-32 bg-[#F6F6EE]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="fade-up">
      <div class="flex items-center gap-2 mb-6">
        <span class="text-[#2e7d32] text-2xl">⚫︎</span>
        <span class="font-display text-2xl font-bold text-[#231815]">01</span>
      </div>
      
      <div class="mb-10 max-w-3xl">
        <h3 class="text-2xl md:text-4xl font-bold mb-4 leading-relaxed text-[#231815]">
          「生きた数字」が見える。<br />迷いが消える。
        </h3>
        
        <p class="text-[#231815] font-bold text-lg mb-4 flex items-center">
          <svg class="mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          市場価格推移グラフ
        </p>
        
        <p class="text-[#231815] leading-loose">
          全国7市場・14品目の価格情報を一元化。<br />
          過去データと比較することで、意思決定（出荷タイミング）の自信に繋がります。
        </p>
      </div>
      
      <div class="border border-[#231815]/20 rounded-3xl p-6 md:p-8 bg-white shadow-sm overflow-hidden fade-up">
        <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
          <div class="flex gap-2">
            <select id="itemFilter" class="bg-[#F6F6EE] border-none rounded-lg px-4 py-2 text-sm font-bold text-[#231815] focus:ring-2 focus:ring-[#2e7d32] cursor-pointer">
            </select>
            <select id="marketFilter" class="bg-[#F6F6EE] border-none rounded-lg px-4 py-2 text-sm font-bold text-[#231815] focus:ring-2 focus:ring-[#2e7d32] cursor-pointer">
            </select>
          </div>
          <div class="text-right">
            <span class="text-xs text-[#231815]/40 font-mono block">Unit: 円/kg</span>
            <span class="text-[10px] text-[#2e7d32] font-bold">● LIVE DATA</span>
          </div>
        </div>
        
        <div class="relative h-[300px] md:h-[400px] w-full flex items-center justify-center">
          <!-- ローディング表示 -->
          <div id="chartLoader" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm transition-opacity duration-500">
            <div class="w-12 h-12 border-4 border-[#2e7d32]/20 border-t-[#2e7d32] rounded-full animate-spin mb-4"></div>
            <p class="text-[#231815]/60 text-sm font-bold animate-pulse">市場データを取得中...</p>
          </div>
          <canvas id="marketChart"></canvas>
        </div>
      </div>

      <!-- Pre-fetched Data for SSG -->
      <div id="market-data-container" data-prices={JSON.stringify(marketPrices)} hidden></div>
    </div>
  </div>
</section>

<!-- Service 02: Instagram -->
<section data-section-theme="light" id="service-02" class="py-24 md:py-32 bg-[#F0ECDE]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="fade-up">
      <div class="grid md:grid-cols-2 gap-12 items-end">
        <div>
          <div class="flex items-center gap-2 mb-6">
            <span class="text-[#2e7d32] text-2xl">⚫︎</span>
            <span class="font-display text-2xl font-bold text-[#231815]">02</span>
          </div>
          <h3 class="text-2xl md:text-4xl font-bold mb-4 leading-relaxed text-[#231815]">
            選ばれている理由は<br />その「質」
          </h3>
          
          <p class="text-[#231815] font-bold text-lg mb-6 flex items-center">
            <svg class="mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></line>
            </svg>
            Instagramメディア
          </p>
          
          <div class="space-y-4 text-[#231815] leading-loose">
            Instagramフォロワーの年齢層が18~64歳で96%を占めており、<br />
次世代の農業界を担う若手・現役プレイヤーにリーチできます。<br /><br />
また、農家・農業関係者比率は約8割。<br />
農業界でも数少ない“実働世代向け“メディアとして、<br />
高い行動率（エンゲージメント）を誇ります。<br />
          </div>
          
          <div class="mt-8 p-6 bg-white border border-[#231815]/20 rounded-2xl inline-block">
            <div class="font-display text-4xl font-bold text-[#231815]">
              20,000<span class="text-2xl">+</span>
              <span class="text-sm font-normal text-[#231815]/60 ml-2">Followers</span>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-10 lg:gap-12">
          <div class="flex justify-center w-full">
            <div class="w-full max-w-[320px] shadow-sm rounded-2xl overflow-hidden instagram-clip-box bg-white border border-[#231815]/10">
              <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/DOIuN5gjy6W/" data-instgrm-version="14" style=" background:#FFF; border:0; border-radius:0; margin: 0; width:100%; min-width:100%;"></blockquote>
            </div>
          </div>
          <div class="flex justify-center w-full">
            <div class="w-full max-w-[320px] shadow-sm rounded-2xl overflow-hidden instagram-clip-box bg-white border border-[#231815]/10">
              <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/DPKcekJk6--/" data-instgrm-version="14" style=" background:#FFF; border:0; border-radius:0; margin: 0; width:100%; min-width:100%;"></blockquote>
            </div>
          </div>
        </div>
        <script is:inline src="//www.instagram.com/embed.js"></script>
      </div>
    </div>
  </div>
</section>

<!-- Service 03: AI Support -->
<section data-section-theme="light" id="service-03" class="py-24 md:py-32 bg-[#E8E4D8]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="fade-up">
      <div class="flex items-center gap-2 mb-6">
        <span class="text-[#2e7d32] text-2xl">⚫︎</span>
        <span class="font-display text-2xl font-bold text-[#231815]">03</span>
        <span class="bg-[#2e7d32] text-white text-xs font-bold px-4 py-1.5 rounded-full ml-2">
          COMING SOON
        </span>
      </div>
      
      <div class="grid md:grid-cols-2 gap-12 items-end">
        <div>
          <h3 class="text-2xl md:text-4xl font-bold mb-4 leading-relaxed text-[#231815]">
            栽培の悩みも、<br />補助金のことも。<br />
            「誰に聞けばいいか<br class="hidden md:block" />分からない」を無くします。
          </h3>
          
          <p class="text-[#231815] font-bold text-lg mb-6 flex items-center">
            <svg class="mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
            農業AI専用サポート
          </p>
          
          <p class="text-[#231815] leading-loose mb-4">
            栽培技術から補助金申請まで。24時間365日、あなたの疑問に即座に応えるパートナーAI。
          </p>
          
          <p class="text-sm text-[#231815]/60">※現在サービス構築中です</p>
        </div>
        
        <div class="bg-white rounded-2xl border border-[#231815]/20 p-8 h-64 flex items-center justify-center">
          <div class="text-center">
            <svg class="mx-auto mb-4 text-[#231815]/40" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
            <span class="text-[#231815]/60">AI Chat Interface</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Service 04: Web Production -->
<section data-section-theme="light" id="service-04" class="py-24 md:py-32 bg-[#F6F6EE]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="fade-up">
      <div class="grid md:grid-cols-2 gap-12 items-end">
        <div class="order-2 md:order-1 bg-white rounded-2xl border border-[#231815]/20 p-8 h-64 flex items-center justify-center">
          <div class="text-center">
            <svg class="mx-auto mb-4 text-[#231815]/40" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 19l7-7 3 3-7 7-3-3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <path d="M2 2l7.586 7.586" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <circle cx="11" cy="11" r="2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></circle>
            </svg>
            <span class="text-[#231815]/60">Web Design Mockup</span>
          </div>
        </div>
        
        <div class="order-1 md:order-2">
          <div class="flex items-center gap-2 mb-6">
            <span class="text-[#2e7d32] text-2xl">⚫︎</span>
            <span class="font-display text-2xl font-bold text-[#231815]">04</span>
          </div>
          <h3 class="text-2xl md:text-4xl font-bold mb-4 leading-relaxed text-[#231815]">
            農業の現場を知る<br />私たちだから、<br />
            想いが伝わるHPが<br class="hidden md:block" />作れる。
          </h3>
          
          <p class="text-[#231815] font-bold text-lg mb-6 flex items-center">
            <svg class="mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 19l7-7 3 3-7 7-3-3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
            農業特化型Web制作
          </p>
          
          <div class="space-y-4 text-[#231815] leading-loose">
            <p>
              「ITはよく分からない」という方でもご安心ください。農業界の知見とWebの技術を持つ私たちが、ヒアリングから公開まで丸ごとサポートします。
            </p>
            <p>
              採用強化や販路拡大に必要な機能を絞り込み、高品質かつリーズナブルな価格で提供します。
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import Chart from 'chart.js/auto';
  import 'chartjs-adapter-luxon';

  interface MarketPrice {
    date: string;
    item: string;
    market: string;
    price: number;
    unit: string;
  }

  async function initChart() {
    const container = document.getElementById('market-data-container');
    if (!container) return;

    // データの読み込み（SSG: 埋め込まれたデータを即座に取得）
    let prices: MarketPrice[] = [];
    try {
      prices = JSON.parse(container.dataset.prices || '[]');
    } catch (e) {
      console.error("Data Load Error:", e);
      return;
    }

    console.log("Market Prices Data Count:", prices.length);

    // ローディングを即座に非表示にする
    const loader = document.getElementById('chartLoader');
    if (loader) {
      loader.style.display = 'none';
    }

    const canvas = document.getElementById('marketChart') as HTMLCanvasElement;
    const itemFilter = document.getElementById('itemFilter') as HTMLSelectElement;
    const marketFilter = document.getElementById('marketFilter') as HTMLSelectElement;

    if (!canvas || !itemFilter || !marketFilter || prices.length === 0) {
      console.warn("Required elements or data missing", { canvas, itemFilter, marketFilter, dataCount: prices.length });
      return;
    }

    // 既存の選択肢をクリア
    itemFilter.innerHTML = '';
    marketFilter.innerHTML = '';

    // フィルターの選択肢を生成
    const items = [...new Set(prices.map(p => p.item))].filter(Boolean).sort();
    const markets = [...new Set(prices.map(p => p.market))].filter(Boolean).sort();

    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      itemFilter.appendChild(opt);
    });

    markets.forEach(market => {
      const opt = document.createElement('option');
      opt.value = market;
      opt.textContent = market;
      marketFilter.appendChild(opt);
    });

    let chart: Chart | null = null;

    function updateChart() {
      const selectedItem = itemFilter.value;
      const selectedMarket = marketFilter.value;

      let filtered = prices.filter(p => 
        p.item === selectedItem && p.market === selectedMarket
      );

      // 日付順にソート（重要：2025-12-08などの形式に対応）
      filtered.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

      // 直近1週間（最新の日付から7日前まで）に絞り込む
      if (filtered.length > 0) {
        const lastDate = new Date(filtered[filtered.length - 1].date);
        const oneWeekAgo = new Date(lastDate);
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        
        filtered = filtered.filter(p => new Date(p.date) >= oneWeekAgo);
      }

      if (chart) {
        chart.destroy();
      }

      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '価格推移',
            data: filtered.map(p => ({ x: new Date(p.date).getTime(), y: p.price })),
            borderColor: '#2e7d32',
            backgroundColor: 'rgba(46, 125, 50, 0.05)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: filtered.length > 30 ? 0 : 3,
            pointHoverRadius: 6,
            pointBackgroundColor: '#2e7d32',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
          }]
        } as any,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#231815',
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: (tooltipItems: any) => {
                  const item = tooltipItems[0];
                  const xValue = item.parsed.x;
                  if (xValue !== null) {
                    const d = new Date(xValue);
                    return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                  }
                  return '';
                },
                label: (context: any) => `${context.parsed.y} 円/kg`
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day', displayFormats: { day: 'M/d' } },
              grid: { display: false },
              ticks: { font: { size: 10, family: 'monospace' }, color: '#231815' }
            },
            y: {
              beginAtZero: false,
              grid: { color: 'rgba(35, 24, 21, 0.05)' },
              ticks: { font: { size: 10, family: 'monospace' }, color: '#231815', callback: (v: any) => `¥${v}` }
            }
          }
        } as any
      });
    }

    itemFilter.addEventListener('change', updateChart);
    marketFilter.addEventListener('change', updateChart);
    
    // 初期状態で最初の品目を選択
    if (items.length > 0) itemFilter.value = items[0];
    updateChart();
  }

  // Astroのライフサイクルに合わせて初期化
  document.addEventListener('astro:page-load', initChart);
  // 初期読み込み時にも実行
  initChart();
</script>

<style>
  /* Instagram埋め込みの強制フィット設定 */
  :global(.instagram-media) {
    margin: 0 !important;
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    /* ヘッダー（プロフィールとボタン）を枠の上に追い出す */
    transform: translateY(-64px);
  }
  
  /* 埋め込み後のiframeの最小幅制限を解除 */
  :global(.instagram-media-rendered iframe) {
    min-width: 100% !important;
  }

  /* はみ出したヘッダーと、下すぎるフッターをカットする */
  .instagram-clip-box {
    height: 437px; /* 動画といいね数が見える絶妙な高さに固定 */
    overflow: hidden;
  }
  @media (max-width: 768px) {
    .instagram-clip-box {
      height: 540px;
    }
  }

  /* ローディングアニメーション */
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>
